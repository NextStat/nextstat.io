<!--
Audit Report
Generated: 2026-02-05 14:00:27
Git Commit: unknown
Scope: docs/plans
Invoked: /audit docs/plans
-->

# Project Audit Report

Date: 2026-02-05
Project: nextstat.io (NextStat plans)
Auditor: Codex
Scope: directory (`docs/plans`)
Git Commit: unknown

---

## Executive Summary

- Critical: 3
- Major: 7
- Minor: 6
- Total: 16

Overall Health Score: 65/100

Top risks: inconsistent definitions of NLL/`twice_nll` plus a contradictory timeline/phase numbering. This creates a high risk of "building the wrong thing" and failing parity/CI late.

---

## Critical Issues

### [Planning] Phase numbering and timeline contradict each other

- File: docs/plans/README.md:31
- Evidence: navigation contains both "Phase 2: CPU Parallelism" and "Phase 2: GPU Backends", while the timeline says "Phase 2: MVP-beta (AD + GPU)". In addition, both phase documents start with "Phase II" and overlap in duration (CPU: docs/plans/phase-2-cpu-parallelism.md:1-7; GPU: docs/plans/phase-2-gpu-backends.md:1-8).
- Impact: planning/estimation slips, confusion in dependencies ("what comes first"), and increased probability of parallel development producing incompatible interfaces.
- Fix: adopt a single scheme, e.g. **Phase 2A (CPU)** and **Phase 2B (GPU)**, or renumber GPU as Phase 3; update `README.md` + Master Plan; add a dependency graph (DAG) for phases/epics and one canonical timeline.
- Confidence: high

### [Correctness] NLL definition does not match what is compared against pyhf

- File: docs/plans/phase-1-mvp-alpha.md:32
- Evidence: Phase I criteria compare `ns.twice_nll` to `pyhf.twice_nll` (docs/plans/phase-1-mvp-alpha.md:32), but later "Poisson NLL" is defined as `lambda - n*ln(lambda)` (docs/plans/phase-1-mvp-alpha.md:902) and tests expect a negative value at `n=lambda` (docs/plans/phase-1-mvp-alpha.md:916-921). A similar "NLL at MLE" test is specified for backends (docs/plans/phase-2-gpu-backends.md:88-112).
- Impact: parity tests against pyhf will fail systematically or be "fixed" with incorrect tolerances; risk of incorrect uncertainties/pulls/scans because different packages optimize different objectives.
- Fix: introduce **one canonical objective** and terminology across all plans:
  1. either compute and compare `twice_nll` (deviance) as pyhf does, or
  2. explicitly name the current `lambda - n ln lambda` as "NLL without constants" and do not compare it to `twice_nll`.
  Then rename APIs (`poisson_twice_nll`, `gaussian_twice_nll`), update tests/formulas/tolerances, and add a short "pyhf parity: what exactly is compared" section.
- Confidence: high

### [Legal] "Commercial license (placeholder)" without open-core boundaries is a legal risk

- File: docs/plans/phase-0-infrastructure.md:61
- Evidence: plans explicitly say "Create commercial license (placeholder)" (docs/plans/phase-0-infrastructure.md:61). The master plan commits to an open-core model (docs/plans/2026-02-05-nextstat-implementation-plan.md:7), but there is no enforceable plan for repo split, which modules are AGPL, how external contributions are handled (DCO vs CLA), and trademark/branding restrictions.
- Impact: risk of an invalid legal structure (licensing/contributions/distribution), which can block the launch or scare off users/contributors.
- Fix: add an explicit "Legal (requires counsel)" section with tasks:
  - decision on repository structure (open vs pro),
  - CONTRIBUTING / DCO / CLA policy,
  - SECURITY policy,
  - trademark/branding,
  - release boundaries (what is published as OSS vs not).
  Mark all license text as **draft** until counsel review.
- Confidence: medium

## Major Issues

### [Docs] Phase 1 document is not self-contained (missing Sprint 1.3-1.5)

- File: docs/plans/phase-1-mvp-alpha.md:1066
- Evidence: the document contains a placeholder: "*[Document continues with Sprint 1.3-1.5...]*" (docs/plans/phase-1-mvp-alpha.md:1066).
- Impact: execution via phase docs breaks: a developer/agent must switch to the Master Plan; high risk of drift.
- Fix: either (A) complete Phase 1 in the phase document, or (B) make the phase document a short index and move canonical steps into the Master Plan / separate sprint files; explicitly declare the source of truth in `docs/plans/README.md`.
- Confidence: high

### [Implementation] Some copy-pasted code in plans does not compile as Rust

- File: docs/plans/phase-2-cpu-parallelism.md:182
- Evidence: signatures like `modifiers: &[impl Fn(...)]` are invalid in Rust (needs generics or trait objects). The GPU plan also contains suspicious explicit closure/iterator types (e.g. `|e: &&mut RankingEntry| ...`, docs/plans/phase-2-gpu-backends.md:1454).
- Impact: plans lose their primary advantage ("executable code"); implementers waste time fixing examples instead of building; higher risk of silent divergence between plan and code.
- Fix: for all significant code blocks:
  - either move them into real skeleton files in the repo and reference from plans, or
  - ensure sketches use correct minimal signatures (generic bounds / `dyn Fn`),
  - and add a rule: "every code block must pass `cargo check` in a dedicated branch".
- Confidence: high

### [Numerics] GPU plan relies on `f32`, but global tolerances target `f64`/pyhf

- File: docs/plans/phase-2-gpu-backends.md:1045
- Evidence: MetalBackend converts data to `f32` (docs/plans/phase-2-gpu-backends.md:1045-1048), while plans specify strict tolerances (e.g. `twice_nll` +/- 1e-8 and mu_hat +/- 1e-6, docs/plans/phase-1-mvp-alpha.md:30-33).
- Impact: GPU parity becomes unrealistic or flaky on real models; risk of endless "chasing 1e-8" and performance regressions.
- Fix: define a "Precision Policy":
  - CPU reference path = f64 + deterministic sum (validation mode),
  - GPU path = mixed precision (f32 compute + f64 accumulation where needed),
  - separate tolerances for GPU vs CPU, and explicit GPU parity tests capturing expected degradation.
- Confidence: high

### [Determinism] Rayon / parallel reductions conflict with strict NLL checks

- File: docs/plans/README.md:20
- Evidence: plans require high-precision parity with pyhf (docs/plans/README.md:20; docs/plans/phase-1-mvp-alpha.md:32), while CPU parallelism uses Rayon (docs/plans/phase-2-cpu-parallelism.md:9-11), which changes summation order (and low bits).
- Impact: unstable results between 1/16 threads and across CPUs -> flaky CI, reduced benchmark trust, inability to "pin" parity.
- Fix: add a deterministic mode plus deterministic reductions (fixed chunk order, pairwise/tree reduction) and/or compensated summation; in CI compare parameters/uncertainties strictly and NLL with a realistic tolerance (or compare delta-NLL).
- Confidence: medium

### [Tooling] Coverage metric tied to `cargo tarpaulin`, limiting platforms

- File: docs/plans/phase-1-mvp-alpha.md:34
- Evidence: acceptance criteria specify `cargo tarpaulin` (docs/plans/phase-1-mvp-alpha.md:34).
- Impact: tarpaulin is often Linux-centric; macOS/dev machines may not support it; CI matrix complexity increases.
- Fix: use `cargo llvm-cov` as the default and keep tarpaulin optional (Linux-only).
- Confidence: medium

### [Docs] README references documents not present in the repository

- File: docs/plans/README.md:216
- Evidence: `NextStat_Business_Strategy_Analysis.md` and `TRExFitter_vs_NextStat_Analysis.md` are referenced (docs/plans/README.md:216-224), but the current tree contains only `docs/plans/`.
- Impact: onboarding new contributors/agents breaks; key inputs are missing.
- Fix: either add these documents to `docs/`, or replace with links/paths to the real storage, or explicitly mark "external (not in repo)".
- Confidence: high

### [Architecture] AD as a critical MVP-beta component has no dedicated plan

- File: docs/plans/2026-02-05-nextstat-implementation-plan.md:19
- Evidence: the Master Plan describes Phase II as "MVP-beta with AD and GPU" (docs/plans/2026-02-05-nextstat-implementation-plan.md:19), but the GPU doc marks AD as TODO (docs/plans/phase-2-gpu-backends.md:1038) and there is no dedicated "phase-2-autodiff.md".
- Impact: critical path risk: without AD, gradients/Hessian/uncertainties may be inaccurate or fits too slow; GPU acceleration without correct gradients provides limited value.
- Fix: add a dedicated AD plan (forward/reverse, Hessian/HVP, constraints, transforms), with parity criteria (gradients vs JAX) and integration into the compute backend / model API.
- Confidence: medium

## Minor Issues

### [Docs] Repeated Claude-specific executor notes reduce portability

- File: docs/plans/2026-02-05-nextstat-implementation-plan.md:3
- Evidence: plans contain "For Claude: REQUIRED SUB-SKILL ..." lines (e.g. docs/plans/2026-02-05-nextstat-implementation-plan.md:3).
- Impact: noise/confusion for other tooling (Codex, Cursor, humans); increases probability of mis-execution.
- Fix: replace with a neutral "For AI agents: execution rules" block or move to a single shared document.
- Confidence: high

### [Docs] Contact section contains `[TBD]` roles without an alternative

- File: docs/plans/README.md:228
- Evidence: `Project Lead` / `Technical Lead` are `[TBD]` (docs/plans/README.md:228-229).
- Impact: no clear escalation/decision ownership.
- Fix: fill in, or replace with "Owners: see CODEOWNERS / MAINTAINERS.md", or remove until real data exists.
- Confidence: medium

### [Consistency] Multiple tolerances stated within Phase 1

- File: docs/plans/phase-1-mvp-alpha.md:30
- Evidence: table says mu_hat +/- 1e-6 (docs/plans/phase-1-mvp-alpha.md:30), but the Python validation example uses `rtol=1e-5` (docs/plans/phase-1-mvp-alpha.md:1106).
- Impact: ambiguous goals -> disputed pass/fail.
- Fix: centralize tolerances into one constant location (e.g. `tests/validation/tolerances.py`) and reference it across plans.
- Confidence: high

### [Docs] NOTICE mentions `THIRD_PARTY_LICENSES` but plans do not create it

- File: docs/plans/phase-0-infrastructure.md:101
- Evidence: NOTICE claims third-party licenses are "listed in THIRD_PARTY_LICENSES" (docs/plans/phase-0-infrastructure.md:101), but Phase 0 does not include a generation task.
- Impact: OSS hygiene expectations are not met.
- Fix: add a task "Generate THIRD_PARTY_LICENSES" (e.g. via `cargo-deny`/`cargo-about` + Python equivalents).
- Confidence: medium

### [Robustness] Job array logic does not validate `job_id`, possible panic/underflow

- File: docs/plans/phase-2-cpu-parallelism.md:968
- Evidence: `job_id - 1` is used without range checks (docs/plans/phase-2-cpu-parallelism.md:975-979).
- Impact: unpredictable crash on a cluster with misconfigured job arrays.
- Fix: validate `1 <= job_id <= total_jobs`, otherwise return a clear error.
- Confidence: medium

### [Wording] "Write failing test" often means "run a command and make it fail"

- File: docs/plans/phase-0-infrastructure.md:269
- Evidence: e.g. "Write failing test (cargo check)" is just `cargo check` without a test harness (docs/plans/phase-0-infrastructure.md:269-275).
- Impact: reduces the value of TDD guidance and can normalize not writing tests.
- Fix: rename to "Sanity check (expected to fail)" or add real tests where possible.
- Confidence: high

## Feature Checklist

### Planning Docs (`docs/plans`)

- [ ] Single source of truth (no duplication)
- [ ] Timeline/phases consistent
- [ ] Canonical math definitions (NLL/twice_nll)
- [ ] Copy/paste code blocks compile
- [ ] Precision/determinism policy defined
- [ ] Legal/open-core boundaries explicit

### Phase 0 Plan (`phase-0-infrastructure.md`)

- [ ] OSS hygiene docs planned (CONTRIBUTING/SECURITY/CODE_OF_CONDUCT)
- [ ] License/compliance automation planned (3rd party licenses)
- [ ] CI includes security scanning (CodeQL/secret scanning)
- [x] CI/deps maintenance (Dependabot) planned
- [x] Developer tooling (pre-commit) planned
- [x] Exit criteria/checklists present

### Phase 1 Plan (`phase-1-mvp-alpha.md`)

- [ ] Sprints 1.3-1.5 fully specified
- [ ] Objective function matches pyhf (`twice_nll`) end-to-end
- [ ] Cross-platform coverage tooling chosen
- [x] Parser/NLL initial tasks specified
- [x] Exit criteria present
- [ ] Validation suite matches stated tolerances

## Unverified Areas

- Did not run/compile code from plan snippets (repo did not yet contain real Rust/Python code at the time of this audit).
- Did not validate HistFactory formulas/modifiers line-by-line against the official pyhf specification.
- Did not validate performance target realism on real workspaces (no baseline reports/datasets in repo at the time).

## Files Reviewed

- docs/plans/README.md
- docs/plans/2026-02-05-nextstat-implementation-plan.md
- docs/plans/phase-0-infrastructure.md
- docs/plans/phase-1-mvp-alpha.md
- docs/plans/phase-2-cpu-parallelism.md
- docs/plans/phase-2-gpu-backends.md

## Recommendations

1. Priority 1: lock a single source of truth and reconcile phase numbering/timeline (Phase 2A/2B), plus add a short dependency graph.
2. Priority 2: normalize math/terms: `twice_nll` vs NLL, precision/determinism policy, realistic tolerances for CPU-parallel and GPU.
3. Priority 3: make plans executable: fix non-compiling snippets or move them into real skeleton files; add missing reference docs or links; add a dedicated Phase 2 Autodiff plan.


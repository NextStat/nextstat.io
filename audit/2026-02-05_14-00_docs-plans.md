<!--
Audit Report
Generated: 2026-02-05 14:00:27
Git Commit: unknown
Scope: docs/plans
Invoked: /audit docs/plans
-->

# Project Audit Report

Date: 2026-02-05
Project: nextstat.io (NextStat plans)
Auditor: Codex
Scope: directory (`docs/plans`)
Git Commit: unknown

---

## Executive Summary

- Critical: 3
- Major: 7
- Minor: 6
- Total: 16

Overall Health Score: 65/100
Top risks: несогласованность определений NLL/`twice_nll` + противоречивый таймлайн/нумерация фаз → высокий риск “построить не то” и провалить parity/CI на поздних этапах.

---

## Critical Issues

### [Planning] Нумерация фаз и таймлайн противоречат друг другу
- File: docs/plans/README.md:31
- Evidence: В навигации есть одновременно “Phase 2: CPU Parallelism” и “Phase 2: GPU Backends”, а в таймлайне “Phase 2: MVP-β (AD + GPU)”. Дополнительно оба phase-документа начинаются с “Фаза II” и имеют перекрывающиеся длительности (CPU: docs/plans/phase-2-cpu-parallelism.md:1–7; GPU: docs/plans/phase-2-gpu-backends.md:1–8).
- Impact: Срывы планирования/оценок, путаница зависимостей (“что раньше”), рост вероятности параллельной реализации несовместимых интерфейсов.
- Fix: Принять единую схему: например **Phase 2A (CPU)** и **Phase 2B (GPU)** или перенумеровать GPU как Phase 3; обновить `README.md` + Master Plan; добавить “Dependency Graph (DAG)” для фаз/epics и один canonical timeline.
- Confidence: high

### [Correctness] Определение NLL не совпадает с тем, что сравнивается с pyhf
- File: docs/plans/phase-1-mvp-alpha.md:32
- Evidence: В критериях Phase I сравнивается `ns.twice_nll` с `pyhf.twice_nll` (docs/plans/phase-1-mvp-alpha.md:32), но дальше “Poisson NLL” определяется как `λ - n*ln(λ)` (docs/plans/phase-1-mvp-alpha.md:902) и тесты ожидают отрицательное значение при `n=λ` (docs/plans/phase-1-mvp-alpha.md:916–921). Аналогичный “NLL at MLE” тест заложен и для backend-ов (docs/plans/phase-2-gpu-backends.md:88–112).
- Impact: Parity-тесты с pyhf будут системно падать или будут “чиниться” неверными допусками; риск неверных uncertainty/pulls/scan, потому что разные пакеты оптимизируют разные целевые функции.
- Fix: Ввести **единый канонический objective** и терминологию во всех планах:
  1) либо считать и сравнивать именно `twice_nll` (deviance) как в pyhf,
  2) либо явно назвать текущее `λ - n ln λ` как “NLL without constants” и не сравнивать его с `twice_nll`.
  Затем: переименовать API (`poisson_twice_nll`, `gaussian_twice_nll`), обновить тесты/формулы/допуски и добавить короткий раздел “pyhf parity: what exactly is compared”.
- Confidence: high

### [Legal] “Commercial license (placeholder)” без границ open-core — юридический риск
- File: docs/plans/phase-0-infrastructure.md:61
- Evidence: Прямо указано “Создать коммерческую лицензию (placeholder)” (docs/plans/phase-0-infrastructure.md:61), при этом в master plan закреплена open-core модель (docs/plans/2026-02-05-nextstat-implementation-plan.md:7), но нет явного плана: как отделяется proprietary код (repo split? private crates?), какие модули точно AGPL, как принимаются внешние контрибы (DCO vs CLA), какие trademark/branding ограничения.
- Impact: Риск некорректной юридической конструкции (лицензирование/контрибуции/дистрибуция), что может заблокировать запуск или отпугнуть пользователей/контрибьюторов.
- Fix: Добавить явный раздел “Legal (requires counsel)” с задачами:
  - решение по структуре репозиториев (open vs pro),
  - CONTRIBUTING/DCO/CLA политика,
  - SECURITY policy,
  - trademark/branding,
  - схема релизов (что публикуется в OSS, что нет).
  В самих шагах отметить, что тексты лицензий — **черновик** до ревью юриста.
- Confidence: medium

## Major Issues

### [Docs] Phase 1 документ не самодостаточен (пропущены Sprint 1.3–1.5)
- File: docs/plans/phase-1-mvp-alpha.md:1066
- Evidence: В середине документа стоит заглушка “*[Документ продолжается с Sprint 1.3-1.5...]*” (docs/plans/phase-1-mvp-alpha.md:1066).
- Impact: Исполнение по phase-документам ломается: разработчик/агент вынужден переключаться на Master Plan; высок риск рассинхронизации.
- Fix: Либо (A) дописать Phase 1 полностью, либо (B) сделать phase-документ коротким “index” и перенести canonical шаги в Master Plan/отдельные sprint-файлы; явно отметить “Source of Truth” в `docs/plans/README.md`.
- Confidence: high

### [Implementation] Часть “копипастного” кода в планах не компилируется как Rust
- File: docs/plans/phase-2-cpu-parallelism.md:182
- Evidence: Используется сигнатура `modifiers: &[impl Fn(...)]` (docs/plans/phase-2-cpu-parallelism.md:182, 216), что невалидно в Rust (нужно generic-параметр/trait object). В GPU-плане встречаются подозрительные явные типы замыканий/итераторов (например `|e: &&mut RankingEntry| ...`, docs/plans/phase-2-gpu-backends.md:1454).
- Impact: Потеря главного преимущества планов (“полный код”) → исполнители тратят время на починку примеров вместо реализации; растёт вероятность “тихих” расхождений между планом и реальным кодом.
- Fix: Для всех крупных код-блоков:
  - либо перенести их в реальные файлы-скелеты в репозитории и ссылаться на них из планов,
  - либо добавлять в план минимальные, но корректные сигнатуры (generic bounds / `dyn Fn`),
  - и добавить правило: “каждый код-блок проходит `cargo check` в отдельной ветке”.
- Confidence: high

### [Numerics] GPU план полагается на `f32`, но глобальные допуски ориентированы на `f64`/pyhf
- File: docs/plans/phase-2-gpu-backends.md:1045
- Evidence: В MetalBackend данные конвертируются в `f32` (docs/plans/phase-2-gpu-backends.md:1045–1048), при этом в планах закреплены строгие допуски (например `twice_nll` ±1e-8 и μ̂ ±1e-6, docs/plans/phase-1-mvp-alpha.md:30–33).
- Impact: GPU parity станет практически недостижимой/флейковой на реальных моделях; риск бесконечной “погони за 1e-8” и деградации производительности.
- Fix: Ввести “Precision Policy”:
  - CPU reference path = f64 и deterministic sum (validation mode),
  - GPU path = mixed precision (f32 compute + f64 accumulation где нужно),
  - разные допуски для GPU vs CPU, и отдельные parity-тесты, фиксирующие ожидаемую деградацию.
- Confidence: high

### [Determinism] Rayon/параллельные редукции конфликтуют со строгой проверкой NLL
- File: docs/plans/README.md:20
- Evidence: В планах заявлена высокая точность сравнения с pyhf (docs/plans/README.md:20; docs/plans/phase-1-mvp-alpha.md:32), но CPU-параллелизм строится на Rayon (docs/plans/phase-2-cpu-parallelism.md:9–11), что меняет порядок суммирования (и, как следствие, младшие биты).
- Impact: Нестабильные результаты между 1/16 потоками и разными CPU → flaky CI, недоверие к бенчмаркам, невозможность “зафиксировать” parity.
- Fix: Добавить “Deterministic mode” + детерминированный reduction (фиксированный порядок чанков, pairwise-tree reduction) и/или compensated summation; в CI сравнивать параметры/uncertainties, а NLL — с реалистичным допуском.
- Confidence: medium

### [Tooling] Метрика покрытия привязана к `cargo tarpaulin`, что ограничивает платформы
- File: docs/plans/phase-1-mvp-alpha.md:34
- Evidence: В acceptance criteria указан `cargo tarpaulin` (docs/plans/phase-1-mvp-alpha.md:34).
- Impact: На macOS/dev-машинах покрытие может быть недоступно; усложнение CI матрицы.
- Fix: Перейти на `cargo llvm-cov` как дефолт и оставить tarpaulin опционально (Linux-only).
- Confidence: medium

### [Docs] README ссылается на документы, отсутствующие в репозитории
- File: docs/plans/README.md:216
- Evidence: Указаны `NextStat_Business_Strategy_Analysis.md` и `TRExFitter_vs_NextStat_Analysis.md` (docs/plans/README.md:216–224), но в текущем дереве `docs/` присутствует только `docs/plans/`.
- Impact: Онбординг новых участников/агентов ломается: ключевые вводные “где брать требования/риски/уроки” недоступны.
- Fix: Либо добавить эти документы в `docs/`, либо заменить на ссылки/пути к реальному хранилищу, либо явно отметить “external (not in repo)”.
- Confidence: high

### [Architecture] AD как ключевая часть MVP-β не имеет отдельного, конкретного плана
- File: docs/plans/2026-02-05-nextstat-implementation-plan.md:19
- Evidence: Master Plan описывает Phase II как “MVP-β с AD и GPU” (docs/plans/2026-02-05-nextstat-implementation-plan.md:19), но в GPU doc AD помечен как TODO (docs/plans/phase-2-gpu-backends.md:1038), а отдельного “phase-2-autodiff.md” нет.
- Impact: Риск “провала по критическому пути”: без AD градиенты/Гессиан/uncertainties либо будут неточны, либо optimisation станет слишком медленным; GPU-ускорение без правильных градиентов даст ограниченную пользу.
- Fix: Добавить отдельный план по AD (forward/reverse, Hessian/LM, constraints, transforms), с критериями parity (градиенты vs JAX) и интеграцией в ComputeBackend.
- Confidence: medium

## Minor Issues

### [Docs] Повторяющаяся привязка к Claude снижает переносимость планов
- File: docs/plans/2026-02-05-nextstat-implementation-plan.md:3
- Evidence: Во всех планах есть строка “For Claude: REQUIRED SUB-SKILL …” (например docs/plans/2026-02-05-nextstat-implementation-plan.md:3).
- Impact: Шум/путаница для других инструментов (Codex, Cursor, humans); повышает вероятность неправильной “инструкции для агента”.
- Fix: Заменить на нейтральный блок “For AI agents (Codex/Claude): execution rules” или вынести в один общий документ.
- Confidence: high

### [Docs] В Contact оставлены `[TBD]` роли без альтернативы
- File: docs/plans/README.md:228
- Evidence: `Project Lead` / `Technical Lead` = `[TBD]` (docs/plans/README.md:228–229).
- Impact: Нет явной точки ответственности/эскалации решений.
- Fix: Либо заполнить, либо заменить на “Owners: see CODEOWNERS / MAINTAINERS.md”, либо убрать секцию до появления реальных данных.
- Confidence: medium

### [Consistency] Разные допуски в одном и том же Phase 1
- File: docs/plans/phase-1-mvp-alpha.md:30
- Evidence: В таблице заявлено μ̂ ±1e-6 (docs/plans/phase-1-mvp-alpha.md:30), но в python validation пример использует `rtol=1e-5` (docs/plans/phase-1-mvp-alpha.md:1106).
- Impact: Размытые цели → спорные результаты (“прошло/не прошло”).
- Fix: Вынести tolerances в одну константу (например `tests/validation/tolerances.py`) и ссылаться на неё во всех планах.
- Confidence: high

### [Docs] NOTICE упоминает `THIRD_PARTY_LICENSES`, но нет задачи его создать/генерировать
- File: docs/plans/phase-0-infrastructure.md:101
- Evidence: В NOTICE говорится, что third-party лицензии “listed in THIRD_PARTY_LICENSES” (docs/plans/phase-0-infrastructure.md:101), но в phase-0 нет явного шага по генерации файла.
- Impact: Несоответствие юридическим ожиданиям OSS-гигиены.
- Fix: Добавить задачу “Generate THIRD_PARTY_LICENSES” (например через `cargo-deny`/`cargo-about` + pip equivalents).
- Confidence: medium

### [Robustness] Job array расчёт не валидирует `job_id`, возможен panic/underflow
- File: docs/plans/phase-2-cpu-parallelism.md:968
- Evidence: Используется `job_id - 1` без проверки диапазона (docs/plans/phase-2-cpu-parallelism.md:975–979).
- Impact: Непредсказуемый крэш на кластере при неверной конфигурации массива.
- Fix: Добавить валидацию: `1 <= job_id <= total_jobs`, иначе понятная ошибка.
- Confidence: medium

### [Wording] “Write failing test” часто означает “запусти команду и упади”
- File: docs/plans/phase-0-infrastructure.md:269
- Evidence: Например “Write failing test (cargo check)” → просто `cargo check` без тестового harness (docs/plans/phase-0-infrastructure.md:269–275).
- Impact: Снижает ценность TDD-инструкций и может вести к привычке без тестов.
- Fix: Переименовать в “Sanity check (expected to fail)” или добавить реальные тесты там, где это возможно.
- Confidence: high

## Feature Checklist

### Planning Docs (`docs/plans`)
- [ ] Single source of truth (no duplication)
- [ ] Timeline/phases consistent
- [ ] Canonical math definitions (NLL/twice_nll)
- [ ] Copy/paste code blocks compile
- [ ] Precision/determinism policy defined
- [ ] Legal/open-core boundaries explicit

### Phase 0 Plan (`phase-0-infrastructure.md`)
- [ ] OSS hygiene docs planned (CONTRIBUTING/SECURITY/CODE_OF_CONDUCT)
- [ ] License/compliance automation planned (3rd party licenses)
- [ ] CI includes security scanning (CodeQL/secret scanning)
- [x] CI/deps maintenance (Dependabot) planned
- [x] Developer tooling (pre-commit) planned
- [x] Exit criteria/checklists present

### Phase 1 Plan (`phase-1-mvp-alpha.md`)
- [ ] Sprints 1.3–1.5 fully specified
- [ ] Objective function matches pyhf (`twice_nll`) end-to-end
- [ ] Cross-platform coverage tooling chosen
- [x] Parser/NLL initial tasks specified
- [x] Exit criteria present
- [ ] Validation suite matches stated tolerances

## Unverified Areas

- Не запускал/не компилировал код из сниппетов (в репозитории пока нет реального Rust/Python кода).
- Не сверял формулы и модификаторы HistFactory против официальной спецификации pyhf построчно.
- Не проверял реалистичность performance targets на реальных workspace (нет baseline-репортов/датасетов в repo).

## Files Reviewed

- docs/plans/README.md
- docs/plans/2026-02-05-nextstat-implementation-plan.md
- docs/plans/phase-0-infrastructure.md
- docs/plans/phase-1-mvp-alpha.md
- docs/plans/phase-2-cpu-parallelism.md
- docs/plans/phase-2-gpu-backends.md

## Recommendations

1. Priority 1: Зафиксировать единый “source of truth” + согласовать нумерацию фаз/таймлайн (Phase 2A/2B), и ввести короткий dependency graph.
2. Priority 2: Нормализовать математику/термины: `twice_nll` vs NLL, precision/determinism policy, реалистичные допуски для CPU-parallel и GPU.
3. Priority 3: Сделать планы “исполняемыми”: исправить некомпилируемые сниппеты или перенести их в реальные файлы-скелеты; добавить отсутствующие reference-docs или ссылки на них; добавить Phase 2 Autodiff план.


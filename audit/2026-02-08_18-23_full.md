<!--
Audit Report
Generated: 2026-02-08 18:23:55
Git Commit: ca857674a0831f2fed212641caec1aaed2e2ef52
Scope: full
Invoked: /audit full
-->

# Project Audit Report

Date: 2026-02-08
Project: NextStat
Auditor: Codex
Scope: full
Git Commit: ca857674a0831f2fed212641caec1aaed2e2ef52

---

## Executive Summary

- Critical: 0
- Major: 2
- Minor: 3
- Total: 5

Overall Health Score: 82/100
Top risks: `ruzstd` has `panic!()` paths in decoding that can crash ROOT ZSTD decompression on malformed inputs; `nextstat-server` advertises Metal GPU mode but `POST /v1/fit` rejects Metal single-model fits.

---

## Critical Issues

(none found)

## Major Issues

### [Robustness/Security] ROOT ZSTD decompression depends on `ruzstd` decoder with `panic!()` paths
- File: crates/ns-root/src/decompress.rs:1
- Evidence:
  - ROOT ZSTD path uses `ruzstd::decoding::FrameDecoder` thread-local (`ZSTD_DECODER`) and `decode_all(...)` in `decompress_zstd()` (crates/ns-root/src/decompress.rs:12, crates/ns-root/src/decompress.rs:92).
  - `crates/ruzstd` contains multiple `panic!()` sites in decoding code paths (e.g. `crates/ruzstd/src/decoding/decode_buffer.rs:419`, `crates/ruzstd/src/decoding/block_decoder.rs:110`, `crates/ruzstd/src/decoding/frame_decoder.rs:431`).
- Impact: A malformed/corrupted ROOT ZSTD block can crash the process (CLI, Python, server) instead of returning a recoverable error. This is a stability and (depending on threat model) a security concern for untrusted inputs.
- Fix:
  1. Add fuzzing + corpus tests around `ns-root` decompression, and treat panics as failures.
  2. Prefer eliminating `panic!()` from decode paths in the `ruzstd` fork (return `Result` instead), or wrap decode in `catch_unwind` at the boundary and convert to `RootError::Decompression` (as a containment measure).
- Confidence: medium

### [Product/API] `nextstat-server --gpu metal` is accepted, but `/v1/fit` rejects Metal single-model fits
- File: crates/ns-server/src/main.rs:26
- Evidence:
  - CLI accepts `--gpu metal` and validates it at startup (crates/ns-server/src/main.rs:44, crates/ns-server/src/main.rs:93).
  - The fit route returns a bad request for Metal: `"Metal single-model fit not yet supported; use CPU or CUDA"` (crates/ns-server/src/routes.rs:114).
- Impact: Users can deploy the server in “Metal mode” and then discover at runtime that the primary endpoint (`POST /v1/fit`) cannot use Metal, which undermines the GPU story and breaks expectation for Apple Silicon labs.
- Fix:
  1. Implement Metal single-model MLE path (use the existing `ns_inference::gpu_session::metal_session(...)` plumbing), or
  2. If intentionally unsupported, reject `--gpu metal` at startup (or gate it to batch-only endpoints) and document it explicitly.
- Confidence: high

## Minor Issues

### [Expectations] `ns-compute` exposes `CudaBackend` / `MetalBackend` as `ComputeBackend` but they are stubs
- File: crates/ns-compute/src/cuda.rs:1
- Evidence: Both backends compile and implement `ComputeBackend` but return `Error::NotImplemented` for `nll/gradient/hessian` (crates/ns-compute/src/cuda.rs:19, crates/ns-compute/src/metal.rs:19).
- Impact: Easy to misinterpret “feature enabled” as “backend works” when the real GPU path uses separate accelerator types (cuda_batch/metal_batch).
- Fix: Either implement these backends via the accelerator modules, or make them unreachable from public surfaces and document them as placeholders.
- Confidence: high

### [Docs/Clarity] Benchmarks/validation are strong, but cross-vertical “validation artifacts” are not yet a first-class output
- File: docs/WHITEPAPER.md:404
- Evidence: Whitepaper defines “Reproducible Reporting Artifacts (Phase 9.R, Planned)” but the shipped harness outputs are JSON under `tmp/` (Apex2 runners) without a standardized human/audit PDF artifact.
- Impact: Slower adoption in Pharma/FinTech where review is document-driven (validation packs, audit trail expectations).
- Fix: Add a `validation_report.{json,pdf}` generator that consumes Apex2 + dataset fingerprints; keep OSS baseline minimal and deterministic.
- Confidence: medium

### [Marketing/UX] Persona translations (HEP -> DS/Quants/Bio) are not present as an entry-point doc set
- File: docs/tutorials
- Evidence: Current docs lean on canonical HEP language (“nuisance”, “Asimov”, “profile likelihood”). There is no dedicated “for Data Scientists/Quants/Biologists” glossary/quickstart.
- Impact: Friction for non-HEP users even if the engine supports their workflows (GLM, Kalman, PK/NLME).
- Fix: Add persona landing docs + glossary mappings and link them from `README.md` + website.
- Confidence: high

## Feature Checklist

### Public Benchmark + Validation Suite (Cross-vertical)
- [x] Deterministic parity contract vs pyhf (`docs/pyhf-parity-contract.md`)
- [x] Apex2 machine-readable reports (`tests/apex2_master_report.py`)
- [ ] Public “benchmark repo” packaging + reproducible runners
- [ ] Vertical validations (PK/NLME, econometrics, Bayesian ESS/sec) with pinned datasets
- [ ] Human-readable report artifacts (PDF) suitable for audits/reviews

## Unverified Areas

- GPU runtime behavior (CUDA/Metal) not executed here; assessment is code-only.
- How `ruzstd` behaves on adversarial/edge-case frames (needs fuzzing to validate claims).

## Files Reviewed

- /Users/andresvlc/WebDev/nextstat.io/README.md
- /Users/andresvlc/WebDev/nextstat.io/docs/benchmarks.md
- /Users/andresvlc/WebDev/nextstat.io/docs/pyhf-parity-contract.md
- /Users/andresvlc/WebDev/nextstat.io/docs/WHITEPAPER.md
- /Users/andresvlc/WebDev/nextstat.io/crates/ns-root/src/decompress.rs
- /Users/andresvlc/WebDev/nextstat.io/crates/ruzstd/src/decoding/decode_buffer.rs
- /Users/andresvlc/WebDev/nextstat.io/crates/ns-server/src/main.rs
- /Users/andresvlc/WebDev/nextstat.io/crates/ns-server/src/routes.rs
- /Users/andresvlc/WebDev/nextstat.io/crates/ns-compute/src/cuda.rs
- /Users/andresvlc/WebDev/nextstat.io/crates/ns-compute/src/metal.rs

## Recommendations

1. Priority 1: Make ROOT ZSTD decompression non-crashing on malformed inputs (fuzz + remove panics or contain them).
2. Priority 2: Resolve `nextstat-server` Metal story (implement Metal single-fit or reject/document).
3. Priority 3: Turn Apex2 outputs into a publishable validation artifact (JSON schema + PDF generator) and use it for vertical expansion trust-building.


<!--
Audit Report
Generated: 2026-02-07 15:08:13
Git Commit: a47e00b611f4fdaedf72d6c5ea1bec2b2238c6b1
Scope: full
Invoked: /audit full
-->

# Project Audit Report

Date: 2026-02-07
Project: NextStat
Auditor: Codex
Scope: full
Git Commit: a47e00b611f4fdaedf72d6c5ea1bec2b2238c6b1 (working tree was dirty during audit)

---

## Executive Summary

- Critical: 3
- Major: 3
- Minor: 4
- Total: 13

Overall Health Score: 35/100
Top risks: CI is currently red (tests + fmt + clippy), and 1D unbounded optimization is broken (MLE/Laplace fail).

---

## Critical Issues

### [Build/Tests] `cargo test --workspace` fails (1D optimizer rejects infinite bounds)
- File: crates/ns-inference/src/optimizer.rs:191
- Evidence: 1D path hard-rejects non-finite bounds (`invalid bounds for 1D minimize: lo=-inf hi=inf`), causing unit tests to panic (`laplace.rs` and `universal_tests.rs` unwrap on `Err`).
- Impact: CI `Rust Tests` job fails; generic MLE/Laplace workflows fail for common 1D unbounded models (e.g. linear regression without intercept; standard normal example).
- Fix:
  1. In `LbfgsbOptimizer::minimize`, allow `(-inf, inf)` (and semi-infinite) bounds in the 1D special-case.
  2. Implement robust bracketing for golden-section search:
     - Start at `x0` (clamped if finite bounds).
     - Expand left/right until a finite bracket containing a local minimum is found, then run golden search on that finite interval.
     - If bracketing fails, fall back to unconstrained LBFGS (no clamp) for 1D.
  3. Add regression tests for: `(-inf, inf)`, `(-inf, hi)`, `(lo, inf)`, and degenerate bounds.
- Confidence: high

### [CI/Formatting] `cargo fmt --all --check` fails
- File: bindings/ns-py/src/lib.rs:54
- Evidence: `cargo fmt --check` reports diffs in multiple files, including `bindings/ns-py/src/lib.rs`, `crates/ns-translate/src/trex/mod.rs`, `crates/ns-viz/src/distributions.rs`, `crates/ns-viz/src/yields.rs`.
- Impact: CI `Rustfmt` job fails; contributors cannot land PRs without formatting churn.
- Fix:
  1. Run `cargo fmt --all` and commit the result.
  2. Ensure editor/CI uses the pinned toolchain (`rust-toolchain.toml`) to avoid drift.
- Confidence: high

### [CI/Lint] `cargo clippy --workspace --all-targets --all-features -- -D warnings` fails
- File: crates/ns-core/src/types.rs:57
- Evidence: clippy errors include:
  - `clippy::too_many_arguments` on `FitResult::with_covariance` (crates/ns-core/src/types.rs:57)
  - `dead_code` on ROOT parser fields/methods (crates/ns-root/src/file.rs:18; crates/ns-root/src/file.rs:293)
  - style lints that become hard errors under `-D warnings` (e.g. crates/ns-root/src/expr.rs:404; crates/ns-root/src/objects/th1.rs:107).
- Impact: CI `Clippy` job fails; codebase cannot meet its own documented contribution/CI gates.
- Fix:
  1. Decide policy: either (a) keep `-D warnings` and fix/allow lints, or (b) loosen CI.
  2. Minimal path that preserves strict CI:
     - Add a small options struct for `FitResult::with_covariance` or add `#[allow(clippy::too_many_arguments)]` with rationale.
     - For intentional unused fields in binary parsing structs, use `#[allow(dead_code)]` on the specific fields, or remove if truly unused.
     - For purely stylistic clippy lints, either refactor or allow at the function level to keep signal/noise manageable.
  3. Add `cargo clippy` to local dev scripts/Makefile to keep parity with CI.
- Confidence: high

## Major Issues

### [CLI/Wiring] `hypotest-toys` accepts `--gpu` but ignores it
- File: crates/ns-cli/src/main.rs:3251
- Evidence: `let _ = gpu; // TODO: wire GPU batch toy fitting into hypotest flow`
- Impact: user-facing flag behaves like a no-op (silent mismatch between CLI surface area and execution). This can mislead performance expectations and reproducibility.
- Fix:
  1. If unsupported: hard-error when `--gpu` is set for `hypotest-toys` (like `cmd_fit` does for Metal).
  2. If supported: implement the GPU path end-to-end (load model → batch toy fit → compute q~mu → CLs artifacts).
  3. Add a CLI integration test covering `--gpu` behavior.
- Confidence: high

### [Math/Validation] GPU NormSys serialization silently accepts invalid factors and stores log placeholders
- File: crates/ns-translate/src/pyhf/model.rs:2431
- Evidence: for `hi_factor <= 0` or `lo_factor <= 0`, it stores linear fallback coefficients and pushes `0.0` for `ln_hi` / `ln_lo` placeholders.
- Impact: invalid workspaces may proceed without a hard validation error; downstream GPU kernels may compute inconsistent NLL/gradients vs CPU, producing wrong inference rather than a clear failure.
- Fix:
  1. Validate NormSys factors at parse/build time and return `Error::Validation` when factors are non-positive.
  2. If a fallback is truly desired, make it explicit: attach a “degraded/invalid” flag and surface it in outputs/logs; ensure kernels do not use placeholder logs.
  3. Add parity tests ensuring CPU/GPU agree on failure mode for invalid factors.
- Confidence: medium

### [DevEx/Docs] Python tests fail in a default local run (`pytest` cannot import `nextstat`)
- File: .github/workflows/python-tests.yml:1
- Evidence: running `pytest -q` from repo root fails with `ModuleNotFoundError: No module named 'nextstat'` unless the wheel is built/installed (CI builds via `maturin build` then `pip install`).
- Impact: contributors running “obvious” commands locally hit hard failures; increases setup friction and reduces test adoption.
- Fix:
  1. Add a documented `make python-test` target that mirrors CI (maturin build → pip install → pytest).
  2. Add a short section in `README.md` (“Running Python tests locally”) with exact commands.
  3. Optionally add a `tests/python/conftest.py` that errors with a clearer message when the extension module is missing.
- Confidence: high

## Minor Issues

### [Stubs] Feature-gated GPU compute backends are compile-time stubs
- File: crates/ns-compute/src/cuda.rs:1
- Evidence: CUDA/Metal backends implement `ComputeBackend` but return `Error::NotImplemented`.
- Impact: acceptable if clearly communicated; can confuse users if enabled accidentally or advertised as generally available.
- Fix: ensure README/docs clearly distinguish “batch GPU acceleration exists” vs “generic GPU `ComputeBackend` is stub”.
- Confidence: high

### [Stubs] Design-specific placeholder API shipped in Python causal AIPW module
- File: bindings/ns-py/python/nextstat/causal/aipw.py:14
- Evidence: Rosenbaum sensitivity is explicitly “placeholder (API only)”.
- Impact: low; acceptable for forward-compat if documented.
- Fix: add a docstring example clarifying expected user-provided implementation / extension points.
- Confidence: high

### [Perf/Quality] Avoidable allocations in optimizer hot-path (clamping copies parameters)
- File: crates/ns-inference/src/optimizer.rs:99
- Evidence: `clamp_params` allocates a new `Vec<f64>` for each cost/grad evaluation (`ArgminProblem::cost` and `gradient`).
- Impact: for large parameter counts and many iterations, can become a measurable overhead.
- Fix: clamp in-place into a reusable buffer or use an argmin solver/bounds mechanism that avoids per-call allocation.
- Confidence: medium

### [Quality] Unused fields/methods/overly complex return types produce dead_code/type_complexity warnings
- File: crates/ns-root/src/file.rs:18
- Evidence: `FileHeader.begin` / `nbytes_name` not read; `RootFile::file_data` / `is_large` unused; `read_th1_base` returns a complex tuple.
- Impact: contributes to clippy failure under strict `-D warnings`, adds maintenance noise.
- Fix: remove, refactor, or `#[allow]` at the narrowest scope with rationale.
- Confidence: high

## Feature Checklist

### Core Rust (workspace)
- [x] Backend API complete
- [ ] Frontend UI complete
- [x] Wiring verified
- [ ] Error handling
- [ ] Tests
- [ ] Docs

### Python Bindings (ns-py)
- [x] Backend API complete
- [ ] Frontend UI complete
- [ ] Wiring verified
- [ ] Error handling
- [ ] Tests
- [ ] Docs

### CLI (ns-cli)
- [x] Backend API complete
- [ ] Frontend UI complete
- [ ] Wiring verified
- [ ] Error handling
- [x] Tests
- [ ] Docs

### ROOT Reader (ns-root)
- [x] Backend API complete
- [ ] Frontend UI complete
- [ ] Wiring verified
- [ ] Error handling
- [x] Tests
- [ ] Docs

## Unverified Areas

- `cargo test --workspace --all-features` (blocked by restricted network access to fetch missing crates in this environment).
- Full CI parity for the `python-tests` job (requires building wheels and installing dependencies online).
- `cargo doc --workspace --all-features` with `RUSTDOCFLAGS=-D warnings` (not executed here).

## Files Reviewed

- README.md
- Cargo.toml
- Makefile
- .github/workflows/rust-tests.yml
- .github/workflows/python-tests.yml
- crates/ns-inference/src/optimizer.rs
- crates/ns-inference/src/laplace.rs
- crates/ns-inference/src/universal_tests.rs
- crates/ns-inference/src/mle.rs
- crates/ns-core/src/types.rs
- crates/ns-core/src/traits.rs
- crates/ns-root/src/file.rs
- crates/ns-root/src/expr.rs
- crates/ns-root/src/filler.rs
- crates/ns-root/src/objects/th1.rs
- crates/ns-translate/src/pyhf/model.rs
- crates/ns-translate/src/trex/mod.rs
- crates/ns-cli/src/main.rs
- bindings/ns-py/python/nextstat/causal/aipw.py
- crates/ns-compute/src/cuda.rs
- crates/ns-compute/src/metal.rs

## Recommendations

1. Priority 1: make CI green again (fix 1D bounds handling; run `cargo fmt`; address clippy `-D warnings` blockers).
2. Priority 2: tighten validation to fail fast on invalid physics/stat inputs (e.g. NormSys factors) and ensure CPU/GPU parity on failure modes.
3. Priority 3: reduce perf overhead in optimizer/NLL hot paths (avoid per-eval allocations; complete/remove scratch placeholders).


name: Python Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  CARGO_TERM_COLOR: always

jobs:
  test:
    name: Python ${{ matrix.python-version }} on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        python-version: ['3.11', '3.12', '3.13']

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@v1

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Install maturin
        run: pip install "maturin>=1.11,<2.0"

      - name: Build Python package
        working-directory: bindings/ns-py
        run: maturin build --release

      - name: Install Python package
        working-directory: bindings/ns-py
        run: pip install target/wheels/*.whl

      - name: Run Python tests
        run: |
          pip install "pytest>=9.0" "pytest-cov>=7.0" "numpy>=2.0" "pyhf>=0.7.6"
          pytest -q -m "not slow" tests/python

      - name: Render validation pack (JSON + PDF)
        if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.13'
        run: |
          pip install "jsonschema>=4.0"
          mkdir -p artifacts artifacts2 artifacts_jsononly

          # JSON-only smoke (no matplotlib/PDF): prove the script can run in minimal environments.
          bash validation-pack/render_validation_pack.sh \
            --out-dir artifacts_jsononly \
            --workspace tests/fixtures/simple_workspace.json \
            --python python \
            --deterministic \
            --json-only
          python - <<'PY'
          import json
          from pathlib import Path
          import jsonschema
          schema = json.loads(Path("docs/schemas/validation/validation_report_v1.schema.json").read_text())
          inst = json.loads(Path("artifacts_jsononly/validation_report.json").read_text())
          jsonschema.validate(inst, schema)
          print("validation_report_v1 (json-only): schema ok")
          PY

          # PDF renderer dependency (runs via `python -m nextstat.validation_report`).
          pip install "matplotlib>=3.8"
          bash validation-pack/render_validation_pack.sh \
            --out-dir artifacts \
            --workspace tests/fixtures/simple_workspace.json \
            --python python \
            --deterministic
          python - <<'PY'
          import json
          from pathlib import Path
          import jsonschema
          schema = json.loads(Path("docs/schemas/validation/validation_report_v1.schema.json").read_text())
          inst = json.loads(Path("artifacts/validation_report.json").read_text())
          jsonschema.validate(inst, schema)
          print("validation_report_v1: schema ok")
          PY

          # Determinism: re-render using the same Apex2 master input and ensure JSON+PDF are bit-identical.
          bash validation-pack/render_validation_pack.sh \
            --out-dir artifacts2 \
            --workspace tests/fixtures/simple_workspace.json \
            --apex2-master artifacts/apex2_master_report.json \
            --python python \
            --deterministic
          sha256sum artifacts/validation_report.json artifacts2/validation_report.json
          sha256sum artifacts/validation_report.pdf artifacts2/validation_report.pdf
          test "$(sha256sum artifacts/validation_report.json | awk '{print $1}')" = "$(sha256sum artifacts2/validation_report.json | awk '{print $1}')"
          test "$(sha256sum artifacts/validation_report.pdf | awk '{print $1}')" = "$(sha256sum artifacts2/validation_report.pdf | awk '{print $1}')"

      - name: Upload Apex2 report artifact
        if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.13'
        uses: actions/upload-artifact@v4
        with:
          name: apex2-report-${{ matrix.os }}-py${{ matrix.python-version }}
          path: artifacts/*.json

      - name: Upload unified validation report artifacts
        if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.13'
        uses: actions/upload-artifact@v4
        with:
          name: validation-report-${{ matrix.os }}-py${{ matrix.python-version }}
          path: |
            artifacts/validation_report.json
            artifacts/validation_report.pdf

      - name: Upload validation pack determinism artifacts (debug)
        if: always() && matrix.os == 'ubuntu-latest' && matrix.python-version == '3.13'
        uses: actions/upload-artifact@v4
        with:
          name: validation-report-determinism-${{ matrix.os }}-py${{ matrix.python-version }}
          path: |
            artifacts2/validation_report.json
            artifacts2/validation_report.pdf
            artifacts_jsononly/validation_report.json

  lint:
    name: Python Linting
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Install linting tools
        run: |
          pip install "ruff>=0.15" "mypy>=1.19"

      - name: Check formatting with ruff
        run: |
          ruff format --check bindings/ns-py/python

      - name: Lint with ruff
        run: ruff check bindings/ns-py/python

      - name: Type check with mypy
        run: mypy bindings/ns-py/python

  stub-generation:
    name: Generate Python Stubs
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@v1

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Install maturin
        run: pip install "maturin>=1.11,<2.0"

      - name: Build and generate stubs
        working-directory: bindings/ns-py
        run: |
          maturin build --release
          pip install target/wheels/*.whl
          # Stub generation will be added in Phase 1
          echo "Python stub generation - will be added in Phase 1"

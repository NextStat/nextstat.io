name: Rust Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

concurrency:
  group: rust-tests-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  test:
    name: Test Suite
    # PR: github-hosted (security â€” public repo). Push main: self-hosted bench (free, 64 threads).
    runs-on: ${{ github.event_name == 'pull_request' && 'ubuntu-latest' || fromJSON('["self-hosted","linux","x64","bench"]') }}
    strategy:
      fail-fast: false
      matrix:
        # PR: stable only. Push main: stable + beta + nightly.
        rust: ${{ github.event_name == 'pull_request' && fromJSON('["stable"]') || fromJSON('["stable","beta","nightly"]') }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: ${{ matrix.rust }}

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Shellcheck (bash -n) validation pack script
        if: matrix.rust == 'stable'
        run: bash -n validation-pack/render_validation_pack.sh

      - name: validation-pack --help smoke
        if: matrix.rust == 'stable'
        run: |
          set -euo pipefail
          out="$(bash validation-pack/render_validation_pack.sh --help)"
          echo "$out" | grep -q -- "--json-only"
          echo "$out" | grep -q -- "Examples:"

      - name: Run tests
        run: cargo test --workspace --verbose

      - name: Run tests (no default features)
        run: cargo test --workspace --no-default-features --verbose

      - name: Run ns-root RNTuple perf gate
        if: matrix.rust == 'stable'
        run: make rntuple-perf-gate

      - name: Run validation-report CLI tests
        if: matrix.rust == 'stable'
        run: cargo test -p ns-cli --test cli_validation_report --verbose

      - name: Arrow ingest large-offset regression smoke
        if: matrix.rust == 'stable'
        run: |
          cargo test -p ns-translate --features arrow-io test_ingest_large_offsets_basic --verbose
          cargo test -p ns-translate --features arrow-io test_ingest_with_modifiers_large_offsets --verbose
          cargo test -p ns-unbinned --features arrow-io test_event_stores_from_record_batches_accepts_largeutf8_channel --verbose

  trex-one-command:
    name: TREx One-Command Workflow
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: stable

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Run TREx one-command workflow tests
        run: cargo test -p ns-cli --test cli_trex_import_config --test cli_import_trex_config --test cli_run_analysis_spec --test cli_validate --verbose

  wasm-smoke:
    name: WASM Smoke (parquet/zstd adapters)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: stable
          targets: wasm32-unknown-unknown

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Run ns-translate wasm smoke test (ignored)
        run: cargo test -p ns-translate --test wasm_smoke -- --ignored --nocapture

      - name: Run ns-unbinned wasm smoke test (ignored)
        run: cargo test -p ns-unbinned --test wasm_smoke -- --ignored --nocapture

  clippy:
    name: Clippy
    runs-on: ${{ github.event_name == 'pull_request' && 'ubuntu-latest' || fromJSON('["self-hosted","linux","x64","bench"]') }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: stable
          components: clippy

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Run clippy
        run: >
          cargo clippy
          --workspace
          --exclude ns-zstd
          --exclude zstd-shim
          --all-targets
          -- -D warnings

  fmt:
    name: Rustfmt
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: stable
          components: rustfmt

      - name: Check formatting
        run: cargo fmt --all --check

  docs:
    name: Documentation
    runs-on: ${{ github.event_name == 'pull_request' && 'ubuntu-latest' || fromJSON('["self-hosted","linux","x64","bench"]') }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: stable

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Build documentation
        run: cargo doc --workspace --no-deps
        env:
          RUSTDOCFLAGS: -D warnings

  neural-smoke:
    name: Neural PDFs (ort) Smoke
    runs-on: ${{ github.event_name == 'pull_request' && 'ubuntu-latest' || fromJSON('["self-hosted","linux","x64","bench"]') }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: stable

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      # ort-sys downloads prebuilt ONNX Runtime binaries into the OS cache dir:
      # ~/.cache/dfbin/... on Linux. Cache it to avoid repeated downloads.
      - name: Cache ONNX Runtime binaries (ort-sys)
        uses: actions/cache@v4
        with:
          path: ~/.cache/dfbin
          key: ${{ runner.os }}-ort-dfbin-${{ hashFiles('Cargo.lock') }}

      - name: Run FlowPdf integration tests (neural)
        run: cargo test -p ns-unbinned --features neural --test flow_integration --verbose

      - name: Run DcrSurrogate integration tests (neural)
        run: cargo test -p ns-unbinned --features neural --test dcr_integration --verbose

  gpu-cuda:
    name: GPU Tests (CUDA)
    runs-on: [self-hosted, linux, cuda]
    if: github.event_name == 'push' || contains(github.event.pull_request.labels.*.name, 'ci:gpu')
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: stable

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Verify CUDA device
        run: nvidia-smi

      - name: Build ns-compute (CUDA)
        run: cargo build -p ns-compute --features cuda --verbose

      - name: Run ns-compute CUDA tests
        run: cargo test -p ns-compute --features cuda --verbose

      - name: Run ns-inference CUDA tests
        run: cargo test -p ns-inference --features cuda --verbose

      - name: Run CLI unbinned-fit CUDA smoke
        run: cargo test -p ns-cli --features cuda --test cli_unbinned_fit --verbose

  gpu-metal:
    name: GPU Tests (Metal)
    runs-on: [self-hosted, macOS, apple-silicon]
    if: github.event_name == 'push' || contains(github.event.pull_request.labels.*.name, 'ci:gpu')
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: stable

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Verify Metal device
        run: system_profiler SPDisplaysDataType | head -20

      - name: Build ns-compute (Metal)
        run: cargo build -p ns-compute --features metal --verbose

      - name: Run ns-compute Metal tests
        run: cargo test -p ns-compute --features metal --verbose

      - name: Run ns-inference Metal tests
        run: cargo test -p ns-inference --features metal --verbose

      - name: Run CLI unbinned-fit Metal smoke
        run: cargo test -p ns-cli --features metal --test cli_unbinned_fit --verbose

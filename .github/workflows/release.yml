name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  # ── Gate: test, lint, version check ──────────────────────────
  test:
    name: Pre-release validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Validate version matches tag
        if: startsWith(github.ref, 'refs/tags/v')
        shell: bash
        run: |
          TAG="${GITHUB_REF#refs/tags/v}"
          CARGO_VER=$(grep '^version' Cargo.toml | head -1 | sed 's/.*"\(.*\)"/\1/')
          if [ "$TAG" != "$CARGO_VER" ]; then
            echo "::error::Tag v$TAG does not match Cargo.toml version $CARGO_VER"
            exit 1
          fi
          echo "Version $CARGO_VER matches tag v$TAG"

      - name: Check formatting
        run: cargo fmt --all --check

      - name: Clippy
        run: cargo clippy --workspace --all-targets --all-features -- -D warnings

      - name: Tests
        run: cargo test --workspace --all-features

  # ── Python wheels (multi-arch) ───────────────────────────────
  wheels:
    name: Wheel (${{ matrix.target }})
    needs: [test]
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
          - os: ubuntu-latest
            target: aarch64-unknown-linux-gnu
          - os: macos-latest
            target: aarch64-apple-darwin
          - os: macos-13
            target: x86_64-apple-darwin
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build wheel
        uses: PyO3/maturin-action@v1
        with:
          working-directory: bindings/ns-py
          target: ${{ matrix.target }}
          command: build
          args: --release --out dist

      - name: Upload wheel
        uses: actions/upload-artifact@v4
        with:
          name: wheels-${{ matrix.target }}
          path: bindings/ns-py/dist/*.whl

  # ── Source distribution ──────────────────────────────────────
  sdist:
    name: Source distribution
    needs: [test]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build sdist
        uses: PyO3/maturin-action@v1
        with:
          working-directory: bindings/ns-py
          command: sdist
          args: --out dist

      - name: Upload sdist
        uses: actions/upload-artifact@v4
        with:
          name: sdist
          path: bindings/ns-py/dist/*.tar.gz

  # ── CLI binaries ─────────────────────────────────────────────
  cli:
    name: CLI (${{ matrix.target }})
    needs: [test]
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
          - os: macos-latest
            target: aarch64-apple-darwin
          - os: macos-13
            target: x86_64-apple-darwin
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Build CLI binary
        run: cargo build --release -p ns-cli

      - name: Package binary
        shell: bash
        run: |
          mkdir -p dist
          cp target/release/nextstat dist/nextstat-${{ matrix.target }}

      - name: Upload binary
        uses: actions/upload-artifact@v4
        with:
          name: cli-${{ matrix.target }}
          path: dist/nextstat-*

  # ── Whitepaper PDF ───────────────────────────────────────────
  whitepaper:
    name: Whitepaper PDF
    needs: [test]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build PDF
        shell: bash
        run: |
          set -euo pipefail
          if [[ "${GITHUB_REF}" == refs/tags/v* ]]; then
            VER="${GITHUB_REF#refs/tags/v}"
            python3 scripts/build_whitepaper.py --version "$VER"
          else
            python3 scripts/build_whitepaper.py
          fi

      - name: Upload PDF artifact
        uses: actions/upload-artifact@v4
        with:
          name: whitepaper
          path: dist/whitepaper/*

  # ── GitHub Release ───────────────────────────────────────────
  github-release:
    name: GitHub Release
    needs: [wheels, cli, sdist, whitepaper]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: Extract CHANGELOG section
        id: changelog
        shell: bash
        run: |
          TAG="${GITHUB_REF#refs/tags/v}"
          # Extract the section for this version, or fall back to Unreleased
          BODY=$(awk -v ver="$TAG" '
            /^## \[/ {
              if (found) exit
              if (index($0, "[" ver "]") || index($0, "[Unreleased]")) found=1
              next
            }
            found { print }
          ' CHANGELOG.md)
          if [ -z "$BODY" ]; then
            BODY="Release v${TAG}"
          fi
          # Write to file to preserve newlines
          echo "$BODY" > /tmp/release_notes.md

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          body_path: /tmp/release_notes.md
          files: |
            dist/**/*.whl
            dist/**/*.tar.gz
            dist/**/nextstat-*
            dist/**/nextstat-whitepaper-*.pdf
            dist/**/nextstat-whitepaper-*.pdf.sha256

  # ── PyPI publish (optional, needs PYPI_TOKEN secret) ─────────
  pypi-publish:
    name: Publish to PyPI
    needs: [github-release]
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    environment: pypi
    permissions:
      id-token: write
    steps:
      - name: Download wheels
        uses: actions/download-artifact@v4
        with:
          pattern: wheels-*
          path: dist
          merge-multiple: true

      - name: Download sdist
        uses: actions/download-artifact@v4
        with:
          name: sdist
          path: dist

      - name: Publish to PyPI
        uses: PyO3/maturin-action@v1
        env:
          MATURIN_PYPI_TOKEN: ${{ secrets.PYPI_TOKEN }}
        with:
          command: upload
          args: --skip-existing dist/*

name: Apex2 Nightly Slow Validations

on:
  workflow_dispatch:
    inputs:
      bias_pulls_n_toys:
        description: "Number of toys for bias/pulls report"
        required: false
        default: "200"
      sbc_n_runs:
        description: "Number of SBC runs (>=10)"
        required: false
        default: "20"
      sbc_warmup:
        description: "SBC warmup (>=100)"
        required: false
        default: "200"
      sbc_samples:
        description: "SBC samples (>=100)"
        required: false
        default: "200"
  schedule:
    # Mon + Thu at 06:00 UTC (2x/week instead of daily â€” saves ~$30/mo).
    - cron: "0 6 * * 1,4"

concurrency:
  group: apex2-nightly
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  NS_RUN_SLOW: "1"

jobs:
  nightly:
    runs-on: ${{ fromJSON('["self-hosted","linux","x64","bench"]') }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.13"

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: stable

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Install maturin
        run: pip install "maturin>=1.11,<2.0"

      - name: Build Python package
        working-directory: bindings/ns-py
        run: maturin build --release

      - name: Install Python package + deps
        run: |
          pip install bindings/ns-py/target/wheels/*.whl
          pip install "pytest>=9.0" "numpy>=2.0" "pyhf>=0.7.6" "matplotlib>=3.9"

      - name: Run Apex2 master report (slow suites enabled)
        run: |
          mkdir -p artifacts
          python tests/apex2_master_report.py \
            --out artifacts/apex2_master_report.json \
            --pyhf-out artifacts/apex2_pyhf_report.json \
            --root-out artifacts/apex2_root_suite_report.json \
            --bias-pulls \
            --bias-pulls-n-toys "${{ inputs.bias_pulls_n_toys || '200' }}" \
            --bias-pulls-out artifacts/apex2_bias_pulls_report.json \
            --sbc \
            --sbc-out artifacts/apex2_sbc_report.json \
            --sbc-n-runs "${{ inputs.sbc_n_runs || '20' }}" \
            --sbc-warmup "${{ inputs.sbc_warmup || '200' }}" \
            --sbc-samples "${{ inputs.sbc_samples || '200' }}"

      - name: Build CLI (for validation-report)
        run: cargo build --release -p ns-cli

      - name: Run BCa CI method benchmarks (HEP + churn)
        run: |
          set -euo pipefail
          mkdir -p artifacts/bca_ci

          python3 scripts/benchmarks/bench_unbinned_summary_ci.py \
            --runs 12 \
            --n-toys 200 \
            --summary-ci-bootstrap 400 \
            --summary-ci-level 0.68 \
            --threads 1 \
            --out-dir artifacts/bca_ci/unbinned_summary_ci

          python3 scripts/benchmarks/bench_churn_bootstrap_ci_methods.py \
            --n-customers 2000 \
            --n-cohorts 48 \
            --max-time 12 \
            --treatment-fraction 0.3 \
            --n-bootstrap 500 \
            --n-jackknife 160 \
            --runs 8 \
            --conf-level 0.95 \
            --use-default-truth \
            --regenerate-data-per-run \
            --out-dir artifacts/bca_ci/churn_bootstrap_ci_methods

      - name: Check BCa CI release gates
        run: |
          set -euo pipefail
          python3 scripts/benchmarks/check_bca_ci_gates.py \
            --hep-summary artifacts/bca_ci/unbinned_summary_ci/summary.json \
            --churn-summary artifacts/bca_ci/churn_bootstrap_ci_methods/summary.json \
            --out-json artifacts/bca_ci/gate_report.json \
            --out-md artifacts/bca_ci/gate_report.md \
            --hep-max-overhead 1.25 \
            --churn-max-overhead 1.75 \
            --hep-max-fallback-rate 0.05 \
            --churn-max-fallback-rate 0.05 \
            --hep-min-effective-bca-rate 0.95 \
            --churn-min-effective-bca-rate 0.95

      - name: Run BCa skew calibration matrix (informational)
        run: |
          set -euo pipefail
          python3 scripts/benchmarks/bench_bca_skew_calibration.py \
            --runs 8 \
            --seed0 100 \
            --hep-n-toys 120 \
            --hep-summary-ci-bootstrap 300 \
            --hep-summary-ci-level 0.68 \
            --churn-n-bootstrap 300 \
            --churn-n-jackknife 120 \
            --churn-conf-level 0.95 \
            --out-dir artifacts/bca_skew_calibration

      - name: Render validation pack (JSON + PDF)
        run: |
          make validation-pack \
            VALIDATION_PACK_OUT_DIR=artifacts \
            VALIDATION_PACK_WORKSPACE=tests/fixtures/complex_workspace.json \
            VALIDATION_PACK_ARGS="--apex2-master artifacts/apex2_master_report.json --python python --nextstat-bin target/release/nextstat --deterministic"

      - name: Write snapshot index (artifact hashes)
        run: |
          python scripts/benchmarks/write_snapshot_index.py \
            --suite apex2-nightly-slow \
            --artifacts-dir artifacts \
            --out artifacts/snapshot_index.json

      - name: Find baseline (previous successful run artifact)
        id: baseline
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const workflow_id = 'apex2-nightly-slow.yml';
            const artifact_name = 'apex2-nightly-slow';
            const ref = context.ref || '';
            const branch = ref.startsWith('refs/heads/') ? ref.slice('refs/heads/'.length) : '';

            const runs = await github.rest.actions.listWorkflowRuns({
              owner,
              repo,
              workflow_id,
              status: 'success',
              ...(branch ? { branch } : {}),
              per_page: 1,
            });

            if (!runs.data.workflow_runs.length) {
              core.setOutput('found', 'false');
              return;
            }

            const run_id = runs.data.workflow_runs[0].id;
            const arts = await github.rest.actions.listWorkflowRunArtifacts({
              owner,
              repo,
              run_id,
              per_page: 100,
            });

            const a = arts.data.artifacts.find(x => x.name === artifact_name && !x.expired);
            if (!a) {
              core.setOutput('found', 'false');
              return;
            }

            core.setOutput('found', 'true');
            core.setOutput('run_id', String(run_id));
            core.setOutput('artifact_id', String(a.id));

      - name: Download baseline snapshot_index.json
        if: steps.baseline.outputs.found == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const artifact_id = Number('${{ steps.baseline.outputs.artifact_id }}');
            const download = await github.rest.actions.downloadArtifact({
              owner,
              repo,
              artifact_id,
              archive_format: 'zip',
            });
            fs.writeFileSync('baseline_artifact.zip', Buffer.from(download.data));

      - name: Build replication report vs baseline
        if: steps.baseline.outputs.found == 'true'
        run: |
          set -euo pipefail
          mkdir -p baseline
          unzip -q baseline_artifact.zip -d baseline
          test -f baseline/snapshot_index.json

          bash scripts/benchmarks/make_replication_bundle.sh \
            --original-index baseline/snapshot_index.json \
            --artifacts-dir artifacts \
            --suite apex2-nightly-slow \
            --notes "baseline_run_id=${{ steps.baseline.outputs.run_id }}"

          if [[ ! -f baseline/validation_report.json ]]; then
            echo "Baseline artifact does not contain validation_report.json (older baseline). Skipping semantic drift check." >&2
            exit 0
          fi

          python3 scripts/benchmarks/compare_validation_reports.py \
            --baseline baseline/validation_report.json \
            --current artifacts/validation_report.json \
            --out artifacts/.replication/validation_drift_summary.json \
            --meta baseline_run_id=${{ steps.baseline.outputs.run_id }} \
            --meta baseline_artifact_id=${{ steps.baseline.outputs.artifact_id }}

      - name: Upload Apex2 artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: apex2-nightly-slow
          path: |
            artifacts/*
            artifacts/.replication/*

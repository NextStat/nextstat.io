name: Apex2 Nightly Slow Validations

on:
  workflow_dispatch:
    inputs:
      bias_pulls_n_toys:
        description: "Number of toys for bias/pulls report"
        required: false
        default: "200"
      sbc_n_runs:
        description: "Number of SBC runs (>=10)"
        required: false
        default: "20"
      sbc_warmup:
        description: "SBC warmup (>=100)"
        required: false
        default: "200"
      sbc_samples:
        description: "SBC samples (>=100)"
        required: false
        default: "200"
  schedule:
    - cron: "0 6 * * *" # daily 06:00 UTC

env:
  CARGO_TERM_COLOR: always
  NS_RUN_SLOW: "1"

jobs:
  nightly:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.13"

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@v1

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Install maturin
        run: pip install "maturin>=1.11,<2.0"

      - name: Build Python package
        working-directory: bindings/ns-py
        run: maturin build --release

      - name: Install Python package + deps
        run: |
          pip install bindings/ns-py/target/wheels/*.whl
          pip install "pytest>=9.0" "numpy>=2.0" "pyhf>=0.7.6" "matplotlib>=3.9"

      - name: Run Apex2 master report (slow suites enabled)
        run: |
          mkdir -p artifacts
          python tests/apex2_master_report.py \
            --out artifacts/apex2_master_report.json \
            --pyhf-out artifacts/apex2_pyhf_report.json \
            --root-out artifacts/apex2_root_suite_report.json \
            --bias-pulls \
            --bias-pulls-n-toys "${{ inputs.bias_pulls_n_toys || '200' }}" \
            --bias-pulls-out artifacts/apex2_bias_pulls_report.json \
            --sbc \
            --sbc-out artifacts/apex2_sbc_report.json \
            --sbc-n-runs "${{ inputs.sbc_n_runs || '20' }}" \
            --sbc-warmup "${{ inputs.sbc_warmup || '200' }}" \
            --sbc-samples "${{ inputs.sbc_samples || '200' }}"

      - name: Build CLI (for validation-report)
        run: cargo build --release -p ns-cli

      - name: Render validation pack (JSON + PDF)
        run: |
          bash validation-pack/render_validation_pack.sh \
            --out-dir artifacts \
            --apex2-master artifacts/apex2_master_report.json \
            --workspace tests/fixtures/complex_workspace.json \
            --python python \
            --nextstat-bin target/release/nextstat \
            --deterministic

      - name: Write snapshot index (artifact hashes)
        run: |
          python scripts/benchmarks/write_snapshot_index.py \
            --suite apex2-nightly-slow \
            --artifacts-dir artifacts \
            --out artifacts/snapshot_index.json

      - name: Find baseline (previous successful run artifact)
        id: baseline
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const workflow_id = 'apex2-nightly-slow.yml';
            const artifact_name = 'apex2-nightly-slow';
            const ref = context.ref || '';
            const branch = ref.startsWith('refs/heads/') ? ref.slice('refs/heads/'.length) : '';

            const runs = await github.rest.actions.listWorkflowRuns({
              owner,
              repo,
              workflow_id,
              status: 'success',
              ...(branch ? { branch } : {}),
              per_page: 1,
            });

            if (!runs.data.workflow_runs.length) {
              core.setOutput('found', 'false');
              return;
            }

            const run_id = runs.data.workflow_runs[0].id;
            const arts = await github.rest.actions.listWorkflowRunArtifacts({
              owner,
              repo,
              run_id,
              per_page: 100,
            });

            const a = arts.data.artifacts.find(x => x.name === artifact_name && !x.expired);
            if (!a) {
              core.setOutput('found', 'false');
              return;
            }

            core.setOutput('found', 'true');
            core.setOutput('run_id', String(run_id));
            core.setOutput('artifact_id', String(a.id));

      - name: Download baseline snapshot_index.json
        if: steps.baseline.outputs.found == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const artifact_id = Number('${{ steps.baseline.outputs.artifact_id }}');
            const download = await github.rest.actions.downloadArtifact({
              owner,
              repo,
              artifact_id,
              archive_format: 'zip',
            });
            fs.writeFileSync('baseline_artifact.zip', Buffer.from(download.data));

      - name: Build replication report vs baseline
        if: steps.baseline.outputs.found == 'true'
        run: |
          set -euo pipefail
          mkdir -p baseline
          unzip -q baseline_artifact.zip -d baseline
          test -f baseline/snapshot_index.json

          bash scripts/benchmarks/make_replication_bundle.sh \
            --original-index baseline/snapshot_index.json \
            --artifacts-dir artifacts \
            --suite apex2-nightly-slow \
            --notes "baseline_run_id=${{ steps.baseline.outputs.run_id }}"

          if [[ ! -f baseline/validation_report.json ]]; then
            echo "Baseline artifact does not contain validation_report.json (older baseline). Skipping semantic drift check." >&2
            exit 0
          fi

          python3 scripts/benchmarks/compare_validation_reports.py \
            --baseline baseline/validation_report.json \
            --current artifacts/validation_report.json \
            --out artifacts/.replication/validation_drift_summary.json \
            --meta baseline_run_id=${{ steps.baseline.outputs.run_id }} \
            --meta baseline_artifact_id=${{ steps.baseline.outputs.artifact_id }}

      - name: Upload Apex2 artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: apex2-nightly-slow
          path: |
            artifacts/*
            artifacts/.replication/*

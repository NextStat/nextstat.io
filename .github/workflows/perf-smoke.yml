name: Perf Smoke (Opt-in)

on:
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  perf_smoke:
    name: Run perf smoke (quick)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: stable

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Run benches (quick, non-blocking)
        continue-on-error: true
        run: |
          cargo bench -p ns-translate --bench nll_benchmark -- --quick
          cargo bench -p ns-inference --bench mle_benchmark -- --quick

      - name: Write snapshot index (artifact hashes)
        if: always()
        run: |
          set -euo pipefail
          mkdir -p target/criterion
          python3 scripts/benchmarks/write_snapshot_index.py \
            --suite perf-smoke \
            --artifacts-dir target/criterion \
            --out target/criterion/snapshot_index.json

      - name: Find baseline (previous successful run artifact)
        if: always()
        id: baseline
        uses: actions/github-script@v8
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const workflow_id = 'perf-smoke.yml';
            const artifact_name = 'criterion-reports';
            const ref = context.ref || '';
            const branch = ref.startsWith('refs/heads/') ? ref.slice('refs/heads/'.length) : '';

            const runs = await github.rest.actions.listWorkflowRuns({
              owner,
              repo,
              workflow_id,
              status: 'success',
              ...(branch ? { branch } : {}),
              per_page: 1,
            });

            if (!runs.data.workflow_runs.length) {
              core.setOutput('found', 'false');
              return;
            }

            const run_id = runs.data.workflow_runs[0].id;
            if (run_id === context.runId) {
              // Only one successful run exists (this one). No baseline yet.
              core.setOutput('found', 'false');
              return;
            }
            const arts = await github.rest.actions.listWorkflowRunArtifacts({
              owner,
              repo,
              run_id,
              per_page: 100,
            });

            const a = arts.data.artifacts.find(x => x.name === artifact_name && !x.expired);
            if (!a) {
              core.setOutput('found', 'false');
              return;
            }

            core.setOutput('found', 'true');
            core.setOutput('run_id', String(run_id));
            core.setOutput('artifact_id', String(a.id));

      - name: Download baseline criterion artifact
        if: steps.baseline.outputs.found == 'true'
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const artifact_id = Number('${{ steps.baseline.outputs.artifact_id }}');
            const download = await github.rest.actions.downloadArtifact({
              owner,
              repo,
              artifact_id,
              archive_format: 'zip',
            });
            fs.writeFileSync('baseline_artifact.zip', Buffer.from(download.data));

      - name: Build replication report vs baseline
        if: steps.baseline.outputs.found == 'true'
        run: |
          set -euo pipefail
          mkdir -p baseline
          unzip -q baseline_artifact.zip -d baseline
          baseline_index="$(find baseline -maxdepth 4 -name snapshot_index.json | head -n 1)"
          if [[ -z "$baseline_index" ]]; then
            echo "Baseline artifact does not contain snapshot_index.json (older baseline). Skipping drift report." >&2
            exit 0
          fi

          bash scripts/benchmarks/make_replication_bundle.sh \
            --original-index "$baseline_index" \
            --artifacts-dir target/criterion \
            --suite perf-smoke \
            --notes "baseline_run_id=${{ steps.baseline.outputs.run_id }}"
          echo "Drift bundle generated under target/criterion/.replication (informational; not a CI gate)."

      - name: Upload Criterion reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: criterion-reports
          path: |
            target/criterion
            target/criterion/.replication

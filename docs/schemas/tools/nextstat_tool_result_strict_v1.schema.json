{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://nextstat.io/schemas/tools/nextstat_tool_result_strict_v1.schema.json",
  "title": "NextStat Tool Result Envelope v1 (Strict Result Shapes)",
  "type": "object",
  "required": ["schema_version", "ok", "result", "error", "meta"],
  "properties": {
    "schema_version": { "const": "nextstat.tool_result.v1" },
    "ok": { "type": "boolean" },
    "result": {},
    "error": {
      "anyOf": [
        { "type": "null" },
        {
          "type": "object",
          "required": ["type", "message"],
          "properties": {
            "type": { "type": "string" },
            "message": { "type": "string" }
          },
          "additionalProperties": true
        }
      ]
    },
    "meta": {
      "type": "object",
      "required": ["tool_name", "nextstat_version"],
      "properties": {
        "tool_name": {
          "type": "string",
          "enum": [
            "nextstat_fit",
            "nextstat_hypotest",
            "nextstat_hypotest_toys",
            "nextstat_upper_limit",
            "nextstat_ranking",
            "nextstat_discovery_asymptotic",
            "nextstat_scan",
            "nextstat_workspace_audit",
            "nextstat_read_root_histogram"
          ]
        },
        "nextstat_version": { "type": ["string", "null"] },
        "deterministic": { "type": "boolean" },
        "eval_mode": { "type": "string" },
        "threads_requested": { "type": ["integer", "null"] }
      },
      "additionalProperties": true
    }
  },
  "additionalProperties": true,
  "$defs": {
    "fit_result": {
      "type": "object",
      "required": ["nll", "converged", "n_iter", "poi_index", "poi_value", "poi_error", "parameters"],
      "properties": {
        "nll": { "type": "number" },
        "converged": { "type": "boolean" },
        "n_iter": { "type": "integer" },
        "poi_index": { "type": ["integer", "null"] },
        "poi_value": { "type": ["number", "null"] },
        "poi_error": { "type": ["number", "null"] },
        "parameters": {
          "type": "object",
          "additionalProperties": {
            "type": "object",
            "required": ["value", "error"],
            "properties": {
              "value": { "type": "number" },
              "error": { "type": "number" }
            },
            "additionalProperties": true
          }
        }
      },
      "additionalProperties": true
    },
    "hypotest_result": {
      "type": "object",
      "required": ["mu", "cls", "clsb", "clb"],
      "properties": {
        "mu": { "type": "number" },
        "cls": { "type": "number" },
        "clsb": { "type": "number" },
        "clb": { "type": "number" }
      },
      "additionalProperties": true
    },
    "hypotest_toys_result": {
      "type": "object",
      "required": ["mu", "n_toys", "seed", "expected_set", "raw"],
      "properties": {
        "mu": { "type": "number" },
        "n_toys": { "type": "integer", "minimum": 1 },
        "seed": { "type": "integer", "minimum": 0 },
        "expected_set": { "type": "boolean" },
        "raw": {}
      },
      "additionalProperties": true
    },
    "upper_limit_result": {
      "type": "object",
      "required": ["alpha", "obs_limit"],
      "properties": {
        "alpha": { "type": "number" },
        "obs_limit": { "type": "number" },
        "exp_limits": {
          "type": "array",
          "items": { "type": "number" }
        }
      },
      "additionalProperties": true
    },
    "ranking_result": {
      "type": "object",
      "required": ["ranking"],
      "properties": {
        "ranking": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["name"],
            "properties": {
              "name": { "type": "string" }
            },
            "additionalProperties": true
          }
        }
      },
      "additionalProperties": true
    },
    "scan_result": {
      "type": "object",
      "properties": {
        "mu_values": {
          "type": "array",
          "items": { "type": "number" }
        },
        "points": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["mu", "q_mu", "nll_mu", "converged", "n_iter"],
            "properties": {
              "mu": { "type": "number" },
              "q_mu": { "type": "number" },
              "nll_mu": { "type": "number" },
              "converged": { "type": "boolean" },
              "n_iter": { "type": "integer" }
            },
            "additionalProperties": true
          }
        }
      },
      "additionalProperties": true
    },
    "workspace_audit_result": {
      "type": "object",
      "additionalProperties": true
    },
    "discovery_asymptotic_result": {
      "type": "object",
      "required": ["q0", "z0", "p0", "nll_hat", "nll_mu0"],
      "properties": {
        "mu_hat": { "type": ["number", "null"] },
        "nll_hat": { "type": "number" },
        "nll_mu0": { "type": "number" },
        "q0": { "type": "number" },
        "z0": { "type": "number" },
        "p0": { "type": "number" }
      },
      "additionalProperties": true
    },
    "root_histogram_result": {
      "type": "object",
      "required": ["name", "title", "bin_edges", "bin_content", "sumw2", "underflow", "overflow", "underflow_sumw2", "overflow_sumw2"],
      "properties": {
        "name": { "type": "string" },
        "title": { "type": "string" },
        "bin_edges": { "type": "array", "items": { "type": "number" } },
        "bin_content": { "type": "array", "items": { "type": "number" } },
        "sumw2": { "type": ["array", "null"], "items": { "type": "number" } },
        "underflow": { "type": "number" },
        "overflow": { "type": "number" },
        "underflow_sumw2": { "type": ["number", "null"] },
        "overflow_sumw2": { "type": ["number", "null"] }
      },
      "additionalProperties": true
    }
  },
  "allOf": [
    {
      "if": { "properties": { "ok": { "const": true } }, "required": ["ok"] },
      "then": { "properties": { "error": { "type": "null" } } }
    },
    {
      "if": { "properties": { "ok": { "const": false } }, "required": ["ok"] },
      "then": { "properties": { "error": { "type": "object" } } }
    },
    {
      "if": {
        "properties": {
          "ok": { "const": true },
          "meta": { "properties": { "tool_name": { "const": "nextstat_fit" } }, "required": ["tool_name"] }
        },
        "required": ["ok", "meta"]
      },
      "then": { "properties": { "result": { "$ref": "#/$defs/fit_result" } } }
    },
    {
      "if": {
        "properties": {
          "ok": { "const": true },
          "meta": { "properties": { "tool_name": { "const": "nextstat_hypotest" } }, "required": ["tool_name"] }
        },
        "required": ["ok", "meta"]
      },
      "then": { "properties": { "result": { "$ref": "#/$defs/hypotest_result" } } }
    },
    {
      "if": {
        "properties": {
          "ok": { "const": true },
          "meta": { "properties": { "tool_name": { "const": "nextstat_hypotest_toys" } }, "required": ["tool_name"] }
        },
        "required": ["ok", "meta"]
      },
      "then": { "properties": { "result": { "$ref": "#/$defs/hypotest_toys_result" } } }
    },
    {
      "if": {
        "properties": {
          "ok": { "const": true },
          "meta": { "properties": { "tool_name": { "const": "nextstat_upper_limit" } }, "required": ["tool_name"] }
        },
        "required": ["ok", "meta"]
      },
      "then": { "properties": { "result": { "$ref": "#/$defs/upper_limit_result" } } }
    },
    {
      "if": {
        "properties": {
          "ok": { "const": true },
          "meta": { "properties": { "tool_name": { "const": "nextstat_ranking" } }, "required": ["tool_name"] }
        },
        "required": ["ok", "meta"]
      },
      "then": { "properties": { "result": { "$ref": "#/$defs/ranking_result" } } }
    },
    {
      "if": {
        "properties": {
          "ok": { "const": true },
          "meta": { "properties": { "tool_name": { "const": "nextstat_scan" } }, "required": ["tool_name"] }
        },
        "required": ["ok", "meta"]
      },
      "then": { "properties": { "result": { "$ref": "#/$defs/scan_result" } } }
    },
    {
      "if": {
        "properties": {
          "ok": { "const": true },
          "meta": { "properties": { "tool_name": { "const": "nextstat_workspace_audit" } }, "required": ["tool_name"] }
        },
        "required": ["ok", "meta"]
      },
      "then": { "properties": { "result": { "$ref": "#/$defs/workspace_audit_result" } } }
    },
    {
      "if": {
        "properties": {
          "ok": { "const": true },
          "meta": { "properties": { "tool_name": { "const": "nextstat_discovery_asymptotic" } }, "required": ["tool_name"] }
        },
        "required": ["ok", "meta"]
      },
      "then": { "properties": { "result": { "$ref": "#/$defs/discovery_asymptotic_result" } } }
    },
    {
      "if": {
        "properties": {
          "ok": { "const": true },
          "meta": { "properties": { "tool_name": { "const": "nextstat_read_root_histogram" } }, "required": ["tool_name"] }
        },
        "required": ["ok", "meta"]
      },
      "then": { "properties": { "result": { "$ref": "#/$defs/root_histogram_result" } } }
    }
  ]
}
